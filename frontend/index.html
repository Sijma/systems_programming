<!DOCTYPE html>
<html>
<head>
  <title>Recommendation System</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h1>Recommendation System</h1>

  <div id="loginSection">
    <h2>Login</h2>
    <form id="loginForm">
      <label for="loginUsername">Username:</label>
      <input type="text" id="loginUsername" name="loginUsername"><br><br>

      <label for="loginPassword">Password:</label>
      <input type="password" id="loginPassword" name="loginPassword"><br><br>

      <button type="submit">Login</button>
    </form>
  </div>

  <div id="registerSection">
    <h2>Register</h2>
    <form id="registerForm">
      <label for="registerUsername">Username:</label>
      <input type="text" id="registerUsername" name="registerUsername"><br><br>

      <label for="registerPassword">Password:</label>
      <input type="password" id="registerPassword" name="registerPassword"><br><br>

      <label for="registerEmail">Email:</label>
      <input type="email" id="registerEmail" name="registerEmail"><br><br>

      <button type="submit">Register</button>
    </form>
  </div>

  <div id="recommendationSection" style="display: none;">
    <h2>Get Recommendation</h2>
    <form id="recommendationForm">
      <label for="generator">Generator:</label>
      <input type="text" id="generator" name="generator"><br><br>

      <label for="userId">User ID:</label>
      <input type="text" id="userId" name="userId"><br><br>

      <label for="amount">Amount:</label>
      <input type="number" id="amount" name="amount"><br><br>

      <button type="submit">Get Recommendation</button>
    </form>
  </div>

  <div id="result"></div>

  <script>
    $(document).ready(function() {
      // Check if the user is logged in
      var jwtToken = getCookie("jwtToken");
      if (jwtToken) {
        // User is logged in
        showRecommendationSection();
      } else {
        // User is not logged in
        showLoginSection();
      }

      // Login form submission
      $('#loginForm').submit(function(event) {
        event.preventDefault();

        var username = $('#loginUsername').val();
        var password = $('#loginPassword').val();

        var requestData = {
          "username": username,
          "password": password
        };

        $.ajax({
          url: 'http://localhost:5000/api/login',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(requestData),
          success: function(response) {
            var accessToken = response.access_token;
            setCookie("jwtToken", accessToken, 1);
            showRecommendationSection();
          },
          error: function(error) {
            console.log(error);
          }
        });
      });

      // Register form submission
      $('#registerForm').submit(function(event) {
        event.preventDefault();

        var username = $('#registerUsername').val();
        var password = $('#registerPassword').val();
        var email = $('#registerEmail').val();

        var requestData = {
          "username": username,
          "password": password,
          "email": email
        };

        $.ajax({
          url: 'http://localhost:5000/api/register',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(requestData),
          success: function(response) {
            console.log(response);
          },
          error: function(error) {
            console.log(error);
          }
        });
      });

      // Recommendation form submission
      $('#recommendationForm').submit(function(event) {
        event.preventDefault();

        var generator = $('#generator').val();
        var userId = $('#userId').val();
        var amount = $('#amount').val();

        var requestData = {
          "generator": generator,
          "user_id": userId,
          "amount": amount
        };

        var jwtToken = getCookie("jwtToken");

        $.ajax({
          url: 'http://localhost:5000/api/recommend',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(requestData),
          headers: {
            "Authorization": "Bearer " + jwtToken
          },
          success: function(response) {
            $('#result').text(JSON.stringify(response));
          },
          error: function(error) {
            console.log(error);
          }
        });
      });

      // Helper functions for managing JWT token as a cookie
      function setCookie(name, value, days) {
        var expires = "";
        if (days) {
          var date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
      }

      function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      // Helper functions for showing/hiding sections
      function showLoginSection() {
        $('#loginSection').show();
        $('#registerSection').show();
        $('#recommendationSection').hide();
      }

      function showRecommendationSection() {
        $('#loginSection').hide();
        $('#registerSection').hide();
        $('#recommendationSection').show();
      }
    });
  </script>
</body>
</html>
